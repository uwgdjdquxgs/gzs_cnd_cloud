<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Native Media Store V3</title>
    <style>
        :root {
            --primary-color: #000000;
            --bg-color: #f3f2f1;
            --card-bg: #ffffff;
            --text-color: #323130;
            --danger-color: #d13438;
            --comment-bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        /* Top navigation */
        header {
    background-color: var(--primary-color);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    position: relative;
}

/* Â∑¶Âè≥Âç†‰ΩçÔºå‰øùËØÅÂ±Ö‰∏≠ */
.header-left,
.header-right {
    width: 200px;   /* ÂèØÂæÆË∞É */
    display: flex;
    align-items: center;
}

/* Âè≥‰æßÊåâÈíÆÈù†Âè≥ */
.header-right {
    justify-content: flex-end;
}

/* Ê†áÈ¢òÁúüÊ≠£Â±Ö‰∏≠ */
.header-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    font-size: 1.5rem;
    white-space: nowrap;
}


        header h1 { margin: 0; font-size: 1.5rem; }

        button {
            cursor: pointer;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        
        button:hover { opacity: 0.9; }

        .btn-primary { background-color: white; color: var(--primary-color); }
        .btn-submit { background-color: var(--primary-color); color: white; width: 100%; margin-top: 10px;}
        .btn-danger { background-color: var(--danger-color); color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem;}
        .btn-edit { background-color: #ffb900; color: black; padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 5px;}
        .btn-small { padding: 0.3rem 0.6rem; font-size: 0.75rem; margin-left: 10px; }
        
        /* Like button style */
        .btn-like { background: transparent; border: 1px solid #ccc; color: #333; display: flex; align-items: center; gap: 5px; padding: 0.4rem 0.8rem; }
        .btn-like:hover { background: #f0f0f0; border-color: #999; }

        /* Main container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Grid layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Card style */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1.6px 3.6px rgba(0,0,0,0.13), 0 0.3px 0.9px rgba(0,0,0,0.11);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }

        .card:hover { transform: translateY(-2px); box-shadow: 0 3.2px 7.2px rgba(0,0,0,0.13), 0 0.6px 1.8px rgba(0,0,0,0.11); }

        .card-media {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #e1dfdd;
            cursor: pointer;
        }

        .card-body { padding: 1rem; flex-grow: 1; }
        .card-title { margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: bold; }
        .card-text { color: #605e5c; font-size: 0.9rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-footer {
            padding: 1rem;
            border-top: 1px solid #e1dfdd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* Detail modal specific styles */
        .modal-detail { max-width: 800px; }
        .detail-media { width: 100%; max-height: 500px; object-fit: contain; margin-bottom: 1rem; background: black; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.5rem;
            border: 1px solid #8a8886; border-radius: 4px; box-sizing: border-box;
        }

        .close-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem; color: #605e5c;
        }

        /* Loading */
        .loader { text-align: center; padding: 2rem; display: none; }

        /* ================= New: Comments section styles ================= */
        .comments-section {
            margin-top: 2rem;
            border-top: 1px solid #e1dfdd;
            padding-top: 1rem;
        }
        .comments-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; }
        .comment-item {
            background-color: var(--comment-bg);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-color);
        }
        .comment-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        .comment-text { font-size: 0.95rem; }
        .add-comment-box {
            margin-top: 1.5rem;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
        }
        .add-comment-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .add-comment-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
    <div class="header-left"></div>

    <h1 class="header-title">Cloud Native Media Store</h1>

    <div class="header-right">
        <button class="btn-primary" onclick="openFormModal()">+ Add New Content</button>
    </div>
</header>


    <div class="container">
        <div id="loader" class="loader">Loading data...</div>
        <div id="post-grid" class="grid">
            </div>
    </div>

    <div id="form-modal" class="modal-overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeFormModal()">&times;</button>
            <h2 id="modal-title">Create New Post</h2>
            
            <form id="post-form">
                <input type="hidden" id="post-id">
                <input type="hidden" id="current-media-url">

                <div class="form-group">
                    <label>Media File (Image/Video)</label>
                    <input type="file" id="file-input" accept="image/*,video/*">
                    <small style="color: #666; display: block; margin-top: 5px;" id="file-status">No file selected (If editing and not changing the file, you can leave this empty)</small>
                </div>

                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="input-header" required placeholder="Enter title">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="input-text" rows="4" required placeholder="Enter detailed description"></textarea>
                </div>

                <button type="submit" class="btn-submit" id="submit-btn">Submit</button>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal modal-detail">
            <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            <div id="detail-content">
                </div>
        </div>
    </div>

<script>
    // ================= Configuration =================
    const ENDPOINTS = {
        // Logic Apps
        UPLOAD: "https://prod-15.koreacentral.logic.azure.com:443/workflows/0817a48ad9c6493dbba2476e78eb473f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=BdCMlzci6o0XreVuLDUXrmWrM6_R_cYmqKzjnUmjLks", 
        ADD: "https://prod-14.koreacentral.logic.azure.com:443/workflows/5d118c30ac2e4610bc5d4d27d20d35d4/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=88DrMgkRKoDyvHdc_X2kMZhZfLaYONva2Mnz3EXhJX8",
        GET_ALL: "https://prod-16.koreacentral.logic.azure.com:443/workflows/230ad18fc28e4230b4d189d5a16e69bf/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=43cNa_br4C75BTLGtHwVPwH0UJHFbM13l4MXVJNxMHo",
        GET_ONE: "https://prod-13.koreacentral.logic.azure.com:443/workflows/b0585e295a894cc8a461f41e748208ea/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=W_N1g2MLOB4-GtqY1vMBE5w1JRo98ubisg3NfprYGEI", 
        DEL: "https://prod-27.koreacentral.logic.azure.com:443/workflows/d20845c12ebe447aad98c8b0ed765a06/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=yvYyiECIpp5qj8Myf3yQC1_HwHqhKZd8wjSzEcUb2a4",
        UPDATE: "https://prod-22.koreacentral.logic.azure.com:443/workflows/dc0b1b12f1b94703be3eabd5afdb8d1c/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=QRZAdSHEs_ZWjlL12vb0odClghBCBm9HhLwWnwKhG1A",
        
        // Azure Functions
        ADD_COMMENT_BASE: "https://functionapp0002-ewe8cmcjgghtcmad.koreacentral-01.azurewebsites.net/api/addComment",
        DEL_COMMENT_BASE: "https://functionapp0002-ewe8cmcjgghtcmad.koreacentral-01.azurewebsites.net/api/delComment",
        ADD_LIKE_BASE: "https://functionapp0002-ewe8cmcjgghtcmad.koreacentral-01.azurewebsites.net/api/addLike"
    };

    // ================= Core Logic =================

    // 1. Init: load list
    async function loadPosts() {
        document.getElementById('loader').style.display = 'block';
        const grid = document.getElementById('post-grid');
        grid.innerHTML = '';

        try {
            const res = await fetch(ENDPOINTS.GET_ALL);
            const data = await res.json();
            
            if (data.length === 0) {
                grid.innerHTML = '<p style="text-align:center; width:100%;">No content available. Click "Add New Content" in the top-right to create one.</p>';
                return;
            }

            data.forEach(item => {
                const card = createCardElement(item);
                grid.appendChild(card);
            });
        } catch (err) {
            console.error(err);
            alert("Failed to load list: " + err.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    // 2. Create card DOM
    function createCardElement(item) {
        const div = document.createElement('div');
        div.className = 'card';
        
        let mediaHtml = '';
        const isVideo = item.mediaType === 'video';
        
        if (isVideo) {
            mediaHtml = `<video src="${item.mediaUrl}" class="card-media" preload="metadata"></video>`;
        } else {
            mediaHtml = `<img src="${item.mediaUrl}" class="card-media" alt="cover" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">`;
        }

        // Note: onclick="viewDetail" opens details
        // Like and delete buttons use event.stopPropagation() to prevent opening the detail modal
        div.innerHTML = `
            <div onclick="viewDetail('${item.id}')">
                ${mediaHtml}
                <div class="card-body">
                    <h3 class="card-title">${item.header || 'Untitled'}</h3>
                    <p class="card-text">${item.text || 'No content'}</p>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn-like" onclick="addLike('${item.id}', event)">
                    üëç <span id="like-count-${item.id}">${item.likes || 0}</span>
                </button>

                <div style="margin-left:auto;">
                    <button class="btn-edit" onclick="openEditModal('${item.id}', event)">Edit</button>
                    <button class="btn-danger" onclick="deletePost('${item.id}', event)">Delete</button>
                </div>
            </div>
        `;
        return div;
    }

    // 3. View details (supports video playback + comments)
    async function viewDetail(id) {
        try {
            const res = await fetch(`${ENDPOINTS.GET_ONE}&id=${id}`);
            const item = await res.json();
            
            const contentDiv = document.getElementById('detail-content');
            let mediaTag = '';
            
            if (item.mediaType === 'video') {
                mediaTag = `<video src="${item.mediaUrl}" class="detail-media" controls autoplay></video>`;
            } else {
                mediaTag = `<img src="${item.mediaUrl}" class="detail-media">`;
            }

            // Render base content
            let html = `
                ${mediaTag}
                <h2>${item.header}</h2>
                <p style="white-space: pre-wrap;">${item.text}</p>
                <div style="display:flex; justify-content:space-between; align-items:center; color:#888; margin-top:10px;">
                    <small>Published at: ${item.createdAt || 'Unknown'}</small>
                    <strong>üëç ${item.likes || 0}</strong>
                </div>
                
                <div class="comments-section">
                    <div class="comments-header">Comments (${item.comments ? item.comments.length : 0})</div>
                    
                    <div id="comments-list">
                        ${renderComments(item.comments, item.id)}
                    </div>

                    <div class="add-comment-box">
                        <div style="font-weight:bold; margin-bottom:10px;">Add a new comment</div>
                        <div class="add-comment-row">
                            <input type="text" id="new-comment-name" placeholder="Your name" style="flex:1;">
                            <input type="text" id="new-comment-text" placeholder="Write something..." style="flex:3;">
                        </div>
                        <button class="btn-submit" onclick="submitComment('${item.id}')" style="margin-top:0;">Submit Comment</button>
                    </div>
                </div>
                `;

            contentDiv.innerHTML = html;
            document.getElementById('detail-modal').style.display = 'flex';
        } catch (err) {
            console.error(err);
            alert("Failed to fetch details");
        }
    }

    // Helper: render comment list HTML
    function renderComments(comments, postId) {
        if (!comments || comments.length === 0) {
            return '<div style="color:#888; padding:10px 0;">No comments yet. Be the first to comment!</div>';
        }

        return comments.map(c => `
            <div class="comment-item">
                <div class="comment-meta">
                    <span style="font-weight:bold;">${c.commentName || 'Anonymous'}</span>
                    <span>
                        ${c.commentTime ? new Date(c.commentTime).toLocaleString() : ''}
                        <button class="btn-danger btn-small" onclick="deleteComment('${postId}', '${c.commentId}')">Delete</button>
                    </span>
                </div>
                <div class="comment-text">${c.commentText || ''}</div>
            </div>
        `).join('');
    }

    // ================= Functions =================

    // Like (Optimistic UI)
    async function addLike(id, event) {
        // Stop bubbling so clicking Like doesn't open the detail modal
        if(event) event.stopPropagation();

        const countSpan = document.getElementById(`like-count-${id}`);
        let currentLikes = parseInt(countSpan.innerText) || 0;
        
        // Optimistic update: +1 immediately
        countSpan.innerText = currentLikes + 1;

        // Build URL
        let baseUrl = ENDPOINTS.ADD_LIKE_BASE;
        if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
        const url = `${baseUrl}/${id}`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (res.ok) {
                const data = await res.json();
                countSpan.innerText = data.newLikes; // overwrite with real value
            } else {
                countSpan.innerText = currentLikes; // rollback on failure
                alert("Like failed, please try again");
            }
        } catch (err) {
            console.error(err);
            countSpan.innerText = currentLikes; // rollback on failure
        }
    }

    // Submit comment
    async function submitComment(postId) {
        const nameInput = document.getElementById('new-comment-name');
        const textInput = document.getElementById('new-comment-text');
        
        const name = nameInput.value.trim();
        const text = textInput.value.trim();

        if (!name || !text) {
            alert("Please enter your name and comment!");
            return;
        }

        let baseUrl = ENDPOINTS.ADD_COMMENT_BASE;
        if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
        const url = `${baseUrl}/${postId}`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    commentName: name,
                    commentText: text
                })
            });

            if (res.ok) {
                viewDetail(postId); // refresh detail view
            } else {
                alert("Failed to submit comment. Please check the backend service.");
            }
        } catch (err) {
            console.error(err);
            alert("Comment request error: " + err.message);
        }
    }

    // Delete comment
    async function deleteComment(postId, commentId) {
        if (!confirm("Are you sure you want to delete this comment?")) return;

        let baseUrl = ENDPOINTS.DEL_COMMENT_BASE;
        if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
        const url = `${baseUrl}/${postId}`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    commentId: commentId
                })
            });

            if (res.ok) {
                viewDetail(postId); // refresh
            } else {
                if (res.status === 404) {
                    alert("The comment may have already been deleted");
                    viewDetail(postId); 
                } else {
                    alert("Delete failed");
                }
            }
        } catch (err) {
            console.error(err);
            alert("Request error: " + err.message);
        }
    }

    // Delete post
    async function deletePost(id, event) {
        if(event) event.stopPropagation(); // stop bubbling
        
        if (!confirm("Are you sure you want to delete this post?")) return;
        try {
            const res = await fetch(ENDPOINTS.DEL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            if (res.ok) {
                alert("Deleted successfully");
                loadPosts();
            } else {
                throw new Error("Delete failed");
            }
        } catch (err) {
            alert(err.message);
        }
    }

    // Upload file
    function uploadFileToBlob(file) {
        return new Promise((resolve, reject) => {
            if (!ENDPOINTS.UPLOAD || ENDPOINTS.UPLOAD.includes("‰Ω†ÁöÑ_UPLOAD")) {
                reject(new Error("Please configure the UPLOAD API URL!"));
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Content = reader.result.split(',')[1];
                const folderName = file.type.startsWith('video') ? 'videos' : 'images';
                const fileName = Date.now() + "_" + file.name;

                try {
                    const res = await fetch(ENDPOINTS.UPLOAD, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileName: fileName,
                            fileContent: base64Content,
                            folder: folderName
                        })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        resolve(data.url);
                    } else {
                        reject(new Error("Upload API Error"));
                    }
                } catch (e) { reject(e); }
            };
            reader.onerror = error => reject(error);
        });
    }

    // ================= Form & Modal Logic =================

    document.getElementById('post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";

        const id = document.getElementById('post-id').value; 
        const header = document.getElementById('input-header').value;
        const text = document.getElementById('input-text').value;
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        
        let mediaUrl = document.getElementById('current-media-url').value;
        let mediaType = "image"; 

        try {
            if (file) {
                submitBtn.innerText = "Uploading file...";
                mediaType = file.type.startsWith('video') ? 'video' : 'image';
                mediaUrl = await uploadFileToBlob(file);
            }

            const payload = {
                header: header,
                text: text,
                mediaUrl: mediaUrl,
                mediaType: mediaType
            };

            if (id) {
                submitBtn.innerText = "Saving changes...";
                payload.id = id; 
                const res = await fetch(ENDPOINTS.UPDATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Update failed");
                alert("Updated successfully!");
            } else {
                submitBtn.innerText = "Publishing...";
                const res = await fetch(ENDPOINTS.ADD, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Publish failed");
                alert("Published successfully!");
            }

            closeFormModal();
            loadPosts(); 

        } catch (err) {
            console.error(err);
            alert("Operation failed: " + err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Submit";
        }
    });

    function openFormModal() {
        document.getElementById('post-form').reset();
        document.getElementById('post-id').value = '';
        document.getElementById('current-media-url').value = '';
        document.getElementById('modal-title').innerText = "Create New Post";
        document.getElementById('file-status').innerText = "Please select a file";
        document.getElementById('form-modal').style.display = 'flex';
    }

    async function openEditModal(id, event) {
        if(event) event.stopPropagation(); // stop bubbling
        try {
            const res = await fetch(`${ENDPOINTS.GET_ONE}&id=${id}`);
            const item = await res.json();

            document.getElementById('post-id').value = item.id;
            document.getElementById('input-header').value = item.header;
            document.getElementById('input-text').value = item.text;
            document.getElementById('current-media-url').value = item.mediaUrl;
            
            document.getElementById('modal-title').innerText = "Edit Post";
            document.getElementById('file-status').innerText = "An existing media file is attached. Do not select a new file if you do not want to replace it.";
            
            document.getElementById('form-modal').style.display = 'flex';
        } catch (e) {
            alert("Unable to load data for editing");
        }
    }

    function closeFormModal() {
        document.getElementById('form-modal').style.display = 'none';
    }

    function closeDetailModal() {
        document.getElementById('detail-modal').style.display = 'none';
        document.getElementById('detail-content').innerHTML = ''; 
    }

    window.onclick = function(event) {
        if (event.target.className === 'modal-overlay') {
            event.target.style.display = "none";
            if (event.target.id === 'detail-modal') {
                document.getElementById('detail-content').innerHTML = '';
            }
        }
    }

    // Start
    loadPosts();

</script>
</body>
</html>
