<div class="app-background"></div>

<div class="layout-wrapper">
  
  <!-- 左侧导航 -->
  <app-sidebar 
    [activeMode]="viewMode" 
    (navigate)="onNavigate($event)">
  </app-sidebar>

  <!-- 媒体列表 -->
  <app-post-list 
    [posts]="posts" 
    [loading]="loading" 
    [selectedId]="selectedPost?.id"
    (select)="onSelectPost($event)">
  </app-post-list>

  <!-- 中间舞台 -->
  <main class="island-stage">
    
    <!-- 使用 key 强制刷新动画 -->
    <div class="stage-container" *ngFor="let trigger of [selectedPost?.id || viewMode]">
      
      <!-- 详情视图 -->
      <app-post-detail 
        *ngIf="viewMode === 'view' && selectedPost" 
        [post]="selectedPost">
      </app-post-detail>

      <!-- 表单视图 -->
      <app-post-form 
        *ngIf="viewMode === 'add' || viewMode === 'edit'"
        [isEdit]="viewMode === 'edit'"
        [formData]="formData"
        [previewUrl]="previewUrl"
        [uploading]="uploading"
        (fileSelect)="onFileSelected($event)"
        (save)="onSavePost()"
        (cancel)="viewMode = 'view'">
      </app-post-form>
      
    </div>

    <!-- 悬浮操作坞 -->
    <app-action-dock 
      *ngIf="viewMode === 'view' && selectedPost"
      [likes]="selectedPost.likes || 0"
      [commentCount]="selectedPost.comments?.length || 0"
      [showComments]="showComments"
      (like)="onLike()"
      (toggleComments)="showComments = !showComments"
      (edit)="onGoEdit()"
      (delete)="onDeletePost()">
    </app-action-dock>

    <!-- 评论抽屉 -->
    <!-- 必须包含 [isSubmitting] 和 [deletingId] 这两个绑定 -->
    <app-comment-drawer 
      [isOpen]="showComments"
      [comments]="selectedPost?.comments || []"
      [isSubmitting]="isCommentSubmitting" 
      [deletingId]="commentDeletingId"
      (close)="showComments = false"
      (addComment)="onAddComment($event)"
      (deleteComment)="onDeleteComment($event)">
    </app-comment-drawer>

  </main>
</div>