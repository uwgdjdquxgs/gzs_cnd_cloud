name: Deploy Angular Frontend

on:
  push:
    branches:
      - main
      - 'feature/angular-refactor'  # <--- 加上这一行！监听你的分支
    paths:
      - 'frontend/**'
      - '.github/workflows/**' # 加上这行，方便调试 CI 配置本身

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Dependencies
      run: |
        cd frontend
        npm ci

    - name: Build Angular Project
      run: |
        cd frontend
        npm run build -- --configuration production

    - name: Upload to Blob Storage
      uses: azure/CLI@v1
      with:
        inlineScript: |
          # ⚠️ 注意：请确保这里的路径是正确的
          # Angular 17+ 默认是 frontend/dist/frontend/browser
          # 如果报错找不到文件，可以改成 frontend/dist/frontend 试试
          
          az storage blob upload-batch \
            --account-name staticstorage0002 \
            --auth-mode key \
            --destination '$web' \
            --source frontend/dist/frontend/browser \
            --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --overwrite